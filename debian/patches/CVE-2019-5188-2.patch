From 71ba13755337e19c9a826dfc874562a36e1b24d3 Mon Sep 17 00:00:00 2001
From: Theodore Ts'o <tytso@mit.edu>
Date: Thu, 19 Dec 2019 19:45:06 -0500
Subject: e2fsck: don't try to rehash a deleted directory

If directory has been deleted in pass1[bcd] processing, then we
shouldn't try to rehash the directory in pass 3a when we try to
rehash/reoptimize directories.

Signed-off-by: Theodore Ts'o <tytso@mit.edu>
---
 e2fsck/rehash.c | 2 ++
 1 file changed, 2 insertions(+)

(limited to 'e2fsck/rehash.c')

Index: e2fsprogs-1.42.12/e2fsck/rehash.c
===================================================================
--- e2fsprogs-1.42.12.orig/e2fsck/rehash.c	2020-03-20 16:13:49.905072948 +0100
+++ e2fsprogs-1.42.12/e2fsck/rehash.c	2020-03-20 16:13:49.901072775 +0100
@@ -883,6 +883,8 @@
 		}
 		if (ino == ctx->lost_and_found)
 			continue;
+		if (!ext2fs_test_inode_bitmap2(ctx->inode_dir_map, ino))
+			continue;
 		pctx.dir = ino;
 		if (first) {
 			fix_problem(ctx, PR_3A_PASS_HEADER, &pctx);
